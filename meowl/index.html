<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meowl Pet: Valentine Edition</title>
    <style>
        body {
            margin: 0;
            background-color: #ffeaa7;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 400px;
            height: 700px;
            background-color: #fff;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 8px solid #6c5ce7;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #top-ui {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            pointer-events: none;
            z-index: 10;
        }

        .stat-box {
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 12px;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .bar-container { width: 40px; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; border: 1px solid #000;}
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }

        /* --- MODAL FINAL --- */
        #valentine-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .letter {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            border-top: 20px solid #e17055;
            animation: popUp 0.5s ease;
        }
        .btn-love {
            background: #ff7675; color: white; padding: 10px 20px;
            border: none; border-radius: 20px; font-size: 16px; margin-top: 15px; cursor: pointer;
        }

        #notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #d63031;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            text-shadow: 2px 2px 0 white;
            z-index: 20;
        }

        /* --- ESTILO BOT√ìN M√öSICA --- */
        #music-btn {
            position: absolute;
            top: 80px;
            right: 15px;
            background: #a55eea;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 4px 0 #8854d0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #music-btn:active { box-shadow: none; transform: translateY(4px); }

        @keyframes popUp { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -150%); } }

    </style>
</head>
<body>

<div id="game-container">
    <div id="top-ui">
        <div class="stat-box"> üçó <div class="bar-container"><div id="bar-food" class="bar-fill" style="background:#fab1a0;"></div></div> </div>
        <div class="stat-box"> üßº <div class="bar-container"><div id="bar-clean" class="bar-fill" style="background:#74b9ff;"></div></div> </div>
        <div class="stat-box"> üí§ <div class="bar-container"><div id="bar-sleep" class="bar-fill" style="background:#a29bfe;"></div></div> </div>
        <div class="stat-box"> üéÆ <div class="bar-container"><div id="bar-fun" class="bar-fill" style="background:#fdcb6e;"></div></div> </div>
    </div>
    
    <button id="music-btn" onclick="toggleMusic()">üîä</button>

    <div style="position:absolute; top: 60px; width: 100%; text-align: center; pointer-events: none; z-index:10;">
        <span style="background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 10px; font-weight: bold; color: #d63031; border: 2px solid #ff7675;">
            ‚ù§Ô∏è Amor: <span id="love-percent">0</span>%
        </span>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="notification"></div>

    <div id="valentine-modal">
        <div class="letter">
            <div style="font-size: 50px;">üíå</div>
            <h2 style="color:#d63031">¬°Felicidades!</h2>
            <p style="font-size: 16px; color: #555;">Hiciste a este Meowl feliz igual como lo haces conmigo todos los d√≠as.</p>
            <p style="font-weight: bold; color: #e17055; font-size: 20px; margin-top:20px;">¬°Feliz San Valent√≠n mi amor pechocho! ‚ù§Ô∏è</p>
            <button class="btn-love" onclick="alert('ü•∞ ¬°Te amo muchisimo!')">¬°Te amo!</button>
        </div>
    </div>
</div>

<audio id="bg-music" loop autoplay>
    <source src="musica.mp3" type="audio/mpeg">
</audio>
<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 400;
    canvas.height = 700;

    // --- CARGAR IM√ÅGENES ---
    const imgNormal = new Image(); imgNormal.src = 'meowl_normal.png'; 
    const imgEat = new Image(); imgEat.src = 'meowl_comiendo.png'; 
    const imgSleep = new Image(); imgSleep.src = 'meowl_dormido.png'; 
    const imgFly = new Image(); imgFly.src = 'meowl_volando.png'; 

    // --- CONFIGURACI√ìN ---
    const scenes = { KITCHEN: 0, BATHROOM: 1, BEDROOM: 2, GAME: 3 };
    let currentScene = scenes.KITCHEN;
    
    let stats = { food: 50, clean: 40, sleep: 60, fun: 50, love: 0 };
    
    const meowl = {
        x: 200, y: 380, 
        w: 280, h: 280, 
        isBlinking: false, blinkTimer: 0,
        isEating: false, bubbles: []
    };

    let draggedItem = null;
    const foods = [
        { x: 50, y: 530, w: 70, h: 70, type: 'pizza', icon: 'üçï', ox: 50, oy: 530 },
        { x: 165, y: 530, w: 70, h: 70, type: 'apple', icon: 'üçé', ox: 165, oy: 530 },
        { x: 280, y: 530, w: 70, h: 70, type: 'donut', icon: 'üç©', ox: 280, oy: 530 }
    ];
    const bathTools = [
        { x: 80, y: 560, w: 80, h: 60, type: 'sponge', icon: 'üßΩ', ox: 80, oy: 560 },
        { x: 240, y: 560, w: 80, h: 60, type: 'shower', icon: 'üöø', ox: 240, oy: 560 }
    ];
    const menuButtons = [
        { x: 0, w: 100, label: 'Cocina', scene: scenes.KITCHEN, color: '#ff9ff3' },
        { x: 100, w: 100, label: 'Ba√±o', scene: scenes.BATHROOM, color: '#74b9ff' },
        { x: 200, w: 100, label: 'Cuarto', scene: scenes.BEDROOM, color: '#a29bfe' },
        { x: 300, w: 100, label: 'Jugar', scene: scenes.GAME, color: '#fab1a0' }
    ];

    let lightsOn = true;
    let mouse = { x: 0, y: 0 };
    let dragging = false;
    let showerParticles = [];

    let miniGame = {
        active: false, started: false,
        y: 300, vy: 0, score: 0,
        pipes: []
    };

    // --- CONTROL DE M√öSICA MEJORADO ---
    const bgMusic = document.getElementById('bg-music');
    const musicBtn = document.getElementById('music-btn');
    bgMusic.volume = 0.3;
    let isMusicPlaying = true; // Asumimos que queremos que suene

    // Intentar reproducir al cargar
    window.addEventListener('load', () => {
        bgMusic.play().then(() => {
            // Si funcion√≥
            musicBtn.innerText = "üîä";
            isMusicPlaying = true;
        }).catch(() => {
            // Si el navegador bloque√≥ el autoplay
            console.log("Autoplay bloqueado, esperando interacci√≥n.");
            musicBtn.innerText = "üéµ"; // Icono de 'listo para sonar'
            isMusicPlaying = false;
            
            // Agregar un listener para activar sonido al primer toque
            const unlockAudio = () => {
                bgMusic.play();
                musicBtn.innerText = "üîä";
                isMusicPlaying = true;
                // Remover listeners una vez activado
                document.body.removeEventListener('click', unlockAudio);
                document.body.removeEventListener('touchstart', unlockAudio);
            };
            document.body.addEventListener('click', unlockAudio);
            document.body.addEventListener('touchstart', unlockAudio);
        });
    });

    function toggleMusic() {
        if (isMusicPlaying) {
            bgMusic.pause();
            musicBtn.innerText = "üîá";
            isMusicPlaying = false;
        } else {
            bgMusic.play();
            musicBtn.innerText = "üîä";
            isMusicPlaying = true;
        }
    }

    // --- GAME LOOP ---
    function loop() {
        updateLogic();
        draw();
        requestAnimationFrame(loop);
    }

    function updateLogic() {
        if (!miniGame.active) {
            if(stats.food > 0) stats.food -= 0.03;
            if(stats.clean > 0) stats.clean -= 0.005; 
            if(stats.fun > 0) stats.fun -= 0.02;
            if(lightsOn && stats.sleep > 0) stats.sleep -= 0.02;
            else if(!lightsOn && stats.sleep < 100) stats.sleep += 0.1;
        }
        
        document.getElementById('bar-food').style.width = stats.food + '%';
        document.getElementById('bar-clean').style.width = stats.clean + '%';
        document.getElementById('bar-sleep').style.width = stats.sleep + '%';
        document.getElementById('bar-fun').style.width = stats.fun + '%';
        document.getElementById('love-percent').innerText = Math.floor(stats.love);

        if(stats.love >= 100) {
            document.getElementById('valentine-modal').style.display = 'flex';
        }
    }

    // --- DIBUJADO ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (miniGame.active) {
            drawMiniGame();
            ctx.fillStyle = "red";
            ctx.fillRect(350, 10, 40, 40);
            ctx.fillStyle = "white"; ctx.font="bold 20px Arial"; ctx.fillText("X", 362, 38);
            return;
        }

        drawBackground();
        
        if (!lightsOn) {
            ctx.fillStyle = "rgba(20,20,50,0.6)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        drawMeowlImage(meowl.x, meowl.y);
        
        if (stats.clean < 100) drawDirt();
        drawBubbles();
        drawShowerParticles();
        drawRoomItems();
        
        if (!lightsOn) {
            ctx.fillStyle = "rgba(0,0,50,0.5)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "white"; ctx.font = "30px Arial";
            ctx.fillText("Zzz...", 250, 250 - Math.sin(Date.now()/500)*20);
        }

        drawMenu();
    }

    function drawBackground() {
        let color = "#fff";
        if(currentScene === scenes.KITCHEN) color = "#fffae6";
        if(currentScene === scenes.BATHROOM) color = "#dff9fb";
        if(currentScene === scenes.BEDROOM) color = "#a29bfe";
        if(currentScene === scenes.GAME) color = "#55efc4";
        
        ctx.fillStyle = color;
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        ctx.fillRect(0, 500, canvas.width, 200);
    }

    function drawMeowlImage(x, y) {
        let breath = Math.sin(Date.now()/400)*3;
        if(!lightsOn) breath = Math.sin(Date.now()/1000)*5;

        ctx.save();
        ctx.translate(x, y + breath);

        let currentImg = imgNormal;
        if (!lightsOn) {
            currentImg = imgSleep; 
        } else if (meowl.isEating) {
            currentImg = imgEat;   
        } 
        
        if (lightsOn && !meowl.isEating) {
            if (Math.random() < 0.01) meowl.isBlinking = true;
            if (meowl.isBlinking) {
                meowl.blinkTimer++;
                currentImg = imgSleep; 
                if (meowl.blinkTimer > 5) {
                    meowl.isBlinking = false;
                    meowl.blinkTimer = 0;
                }
            }
        }

        try {
            ctx.drawImage(currentImg, -meowl.w/2, -meowl.h/2, meowl.w, meowl.h);
        } catch (e) {
            ctx.fillStyle = "#6c5ce7";
            ctx.beginPath(); ctx.arc(0,0, 60, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();
    }

    function drawRoomItems() {
        ctx.font = "50px Arial";
        ctx.textAlign = "center";

        if(currentScene === scenes.KITCHEN) {
            for(let f of foods) {
                if(f === draggedItem) {
                    ctx.font = "60px Arial";
                    ctx.fillText(f.icon, f.x, f.y + 50);
                } else {
                    ctx.font = "50px Arial";
                    ctx.fillText(f.icon, f.ox, f.oy + 50);
                }
            }
        }
        else if(currentScene === scenes.BATHROOM) {
            for(let t of bathTools) {
                let dx = (t === draggedItem) ? t.x : t.ox;
                let dy = (t === draggedItem) ? t.y : t.oy;
                ctx.fillText(t.icon, dx, dy + 50);
            }
        }
        else if(currentScene === scenes.BEDROOM) {
            ctx.fillStyle = lightsOn ? "#f1c40f" : "#555";
            ctx.fillRect(300, 200, 10, 150);
            ctx.beginPath(); ctx.moveTo(280, 350); ctx.lineTo(330, 350); ctx.lineTo(350, 390); ctx.lineTo(260, 390); ctx.fill();
            ctx.fillStyle = "#333";
            ctx.fillRect(290, 420, 40, 60);
            ctx.fillStyle = lightsOn ? "#0f0" : "#f00";
            ctx.fillRect(305, 435, 10, 30);
        }
        else if(currentScene === scenes.GAME && !miniGame.active) {
            ctx.fillStyle = "#333";
            ctx.font = "20px Comic Sans MS";
            ctx.fillText("Toca la pantalla para jugar", 200, 300);
            ctx.font = "60px Arial";
            ctx.fillText("‚ñ∂Ô∏è", 200, 380);
        }
    }

    function drawMenu() {
        let y = 620;
        ctx.font = "bold 16px Arial";
        ctx.textAlign = "center";
        for (let btn of menuButtons) {
            ctx.fillStyle = (currentScene === btn.scene) ? "#fff" : btn.color;
            ctx.fillRect(btn.x, y, btn.w, 80);
            ctx.strokeStyle = "#555";
            ctx.strokeRect(btn.x, y, btn.w, 80);
            ctx.fillStyle = "#333";
            ctx.fillText(btn.label, btn.x + btn.w/2, y + 45);
        }
    }

    function drawDirt() {
        let amount = Math.floor((100 - stats.clean)/10);
        ctx.fillStyle = "#795548";
        for(let i=0; i<amount; i++) {
            let dx = meowl.x + Math.sin(i*123)*80;
            let dy = meowl.y + Math.cos(i*87)*60;
            ctx.beginPath(); ctx.arc(dx, dy, 8, 0, Math.PI*2); ctx.fill();
        }
    }

    function drawBubbles() {
        ctx.strokeStyle = "white"; ctx.lineWidth=2;
        for(let b of meowl.bubbles) {
            ctx.beginPath(); ctx.arc(b.x, b.y, b.s, 0, Math.PI*2); ctx.stroke();
        }
    }
    
    function drawShowerParticles() {
        ctx.fillStyle = "#74b9ff";
        for(let p of showerParticles) {
            ctx.fillRect(p.x, p.y, 4, 8);
            p.y += 15;
        }
        showerParticles = showerParticles.filter(p => p.y < 500);
    }

    function drawMiniGame() {
        ctx.fillStyle = "#81ecec";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        if (miniGame.started) {
            miniGame.vy += 0.4;
            miniGame.y += miniGame.vy;
            if (miniGame.pipes.length === 0 || miniGame.pipes[miniGame.pipes.length-1].x < 200) {
                let gapY = Math.random() * 300 + 100;
                miniGame.pipes.push({ x: 450, y: gapY, gap: 140, passed: false });
            }
        }

        ctx.save();
        ctx.translate(100, miniGame.y);
        ctx.rotate(miniGame.vy * 0.1);
        
        let flyImg = imgFly.complete ? imgFly : imgNormal; 
        try {
            ctx.drawImage(flyImg, -30, -30, 60, 60); 
        } catch(e) {
             ctx.fillStyle = "#6c5ce7"; ctx.beginPath(); ctx.arc(0,0, 20, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();

        ctx.fillStyle = "#00b894"; ctx.strokeStyle = "#006266"; ctx.lineWidth = 3;
        for (let i = 0; i < miniGame.pipes.length; i++) {
            let p = miniGame.pipes[i];
            if (miniGame.started) p.x -= 3;
            ctx.fillRect(p.x, 0, 60, p.y); ctx.strokeRect(p.x, 0, 60, p.y);
            ctx.fillRect(p.x, p.y + p.gap, 60, canvas.height); ctx.strokeRect(p.x, p.y + p.gap, 60, canvas.height);

            if (100 + 15 > p.x && 100 - 15 < p.x + 60) {
                if (miniGame.y - 15 < p.y || miniGame.y + 15 > p.y + p.gap) gameOver();
            }
            if (!p.passed && p.x < 100) { p.passed = true; miniGame.score++; }
        }
        
        miniGame.pipes = miniGame.pipes.filter(p => p.x > -100);
        if (miniGame.y > canvas.height || miniGame.y < 0) gameOver();

        ctx.fillStyle = "white"; ctx.font = "bold 40px Arial"; ctx.strokeStyle = "black"; ctx.lineWidth = 4;
        ctx.strokeText(miniGame.score, 200, 100); ctx.fillText(miniGame.score, 200, 100);
    }

    function gameOver() {
        miniGame.active = false; miniGame.started = false;
        stats.fun = Math.min(100, stats.fun + 20);
        stats.love = Math.min(100, stats.love + 5);
        showNotif("+Diversi√≥n");
    }

    // --- INPUT ---
    function handleStart(x, y) {
        mouse.x = x; mouse.y = y;
        if (miniGame.active && x > 350 && y < 50) { gameOver(); return; }
        if (miniGame.active) { miniGame.vy = -7; if (!miniGame.started) miniGame.started = true; return; }
        if (y > 620) {
            for(let btn of menuButtons) {
                if(x >= btn.x && x < btn.x + btn.w) { currentScene = btn.scene; draggedItem = null; }
            }
            return;
        }
        if (currentScene === scenes.KITCHEN) {
            for(let f of foods) { if(dist(x,y, f.ox + 35, f.oy + 35) < 40) { dragging = true; draggedItem = f; f.x = x - 35; f.y = y - 35; } }
        } else if (currentScene === scenes.BATHROOM) {
            for(let t of bathTools) { if(dist(x,y, t.ox + 40, t.oy + 30) < 40) { dragging = true; draggedItem = t; t.x = x - 40; t.y = y - 30; } }
        } else if (currentScene === scenes.BEDROOM) {
            if(x > 290 && x < 330 && y > 420 && y < 480) lightsOn = !lightsOn;
        } else if (currentScene === scenes.GAME) {
            if(y < 600 && y > 200) { miniGame.active = true; miniGame.y = 300; miniGame.vy = 0; miniGame.score = 0; miniGame.pipes = []; miniGame.started = false; }
        }
    }

    function handleMove(x, y) {
        mouse.x = x; mouse.y = y;
        if (dragging && draggedItem) {
            draggedItem.x = x - draggedItem.w/2; draggedItem.y = y - draggedItem.h/2;
            let d = dist(x, y, meowl.x, meowl.y);
            if (currentScene === scenes.KITCHEN && d < 120) meowl.isEating = true; else meowl.isEating = false;
            if (currentScene === scenes.BATHROOM && d < 130) {
                if(draggedItem.type === 'sponge') { if(Math.random() > 0.7) meowl.bubbles.push({x: x+(Math.random()*20-10), y: y, s: Math.random()*10+5}); }
                else if(draggedItem.type === 'shower') {
                    showerParticles.push({x:x, y:y+30});
                    if(meowl.bubbles.length > 0) { meowl.bubbles.pop(); increaseStats('clean', 1); }
                    else if(stats.clean < 100) increaseStats('clean', 0.2);
                }
            }
        }
    }

    function handleEnd() {
        if(dragging && draggedItem && currentScene === scenes.KITCHEN) {
            if(meowl.isEating) { increaseStats('food', 25); showNotif("¬°√ëam! +üçó"); meowl.isEating = false; }
            draggedItem.x = draggedItem.ox; draggedItem.y = draggedItem.oy;
        }
        if(dragging && draggedItem) { draggedItem.x = draggedItem.ox; draggedItem.y = draggedItem.oy; }
        dragging = false; draggedItem = null;
    }

    function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }
    function increaseStats(type, amount) { stats[type] = Math.min(100, stats[type] + amount); stats.love = Math.min(100, stats.love + (amount * 0.2)); updateLogic(); }
    function showNotif(txt) { const n = document.getElementById('notification'); n.innerText = txt; n.style.animation = 'none'; n.offsetHeight; n.style.animation = 'floatUp 1s ease-out'; }

    canvas.addEventListener('mousedown', e => { let r = canvas.getBoundingClientRect(); handleStart(e.clientX - r.left, e.clientY - r.top); });
    canvas.addEventListener('mousemove', e => { let r = canvas.getBoundingClientRect(); handleMove(e.clientX - r.left, e.clientY - r.top); });
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); let r = canvas.getBoundingClientRect(); handleStart(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); }, {passive: false});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); let r = canvas.getBoundingClientRect(); handleMove(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); }, {passive: false});
    canvas.addEventListener('touchend', handleEnd);

    loop();

</script>
</body>
</html>